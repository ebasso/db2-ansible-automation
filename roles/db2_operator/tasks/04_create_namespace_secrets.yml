---
# Create namespace and secrets for Db2 instance

- name: Create Db2 namespace '{{ db2_namespace }}'
  kubernetes.core.k8s:
    state: present
    definition:
      apiVersion: v1
      kind: Namespace
      metadata:
        name: "{{ db2_namespace }}"
        labels:
          app.kubernetes.io/name: db2
          app.kubernetes.io/instance: "{{ db2_instance_name }}"

- name: Create secret content for IBM Entitlement Registry
  no_log: false
  vars:
    entitled_auth_str: "cp:{{ entitled_registry_key }}"
    entitled_auth_b64: "{{ entitled_auth_str | b64encode }}"
    content:
      auths:
        cp.icr.io:
          username: "cp"
          password: "{{ entitled_registry_key }}"
          email: "cp"
          auth: "{{ entitled_auth_b64 }}"
  ansible.builtin.set_fact:
    new_secret: "{{ content | to_json }}"

- name: Generate IBM Entitlement Registry secret
  no_log: true
  kubernetes.core.k8s:
    definition:
      apiVersion: v1
      kind: Secret
      type: kubernetes.io/dockerconfigjson
      metadata:
        name: "{{ db2_registry_secret }}"
        namespace: "{{ db2_namespace }}"
      data:
        .dockerconfigjson: "{{ new_secret | b64encode }}"

- name: Create Db2 instance credentials secret
  no_log: true
  kubernetes.core.k8s:
    state: present
    definition:
      apiVersion: v1
      kind: Secret
      metadata:
        name: "{{ db2_instance_secret }}"
        namespace: "{{ db2_namespace }}"
      type: Opaque
      stringData:
        password: "{{ db2_instance_password }}"

- name: Display secrets creation status
  ansible.builtin.debug:
    msg:
      - "Secrets created successfully in namespace {{ db2_namespace }}"
      - "  Registry Secret: {{ db2_registry_secret }}"
      - "  Instance Secret: {{ db2_instance_secret }}"

# Made with Bob